# Bikes Virtual Locks

Flutter desktop application that simulates physical bike lock devices for AWS IoT. Used for development and testing of the bikes-api backend.

## Features

- **Simulates multiple virtual bike locks** - Create and manage virtual lock instances
- **AWS IoT Core integration** - Connects via MQTT with device certificates
- **Remote control** - Receives unlock commands via IoT Device Shadow
- **State reporting** - Reports lock state (locked, empty, clamps) back to AWS IoT
- **Auto-lock functionality** - Timer-based automatic re-locking after unlock
- **Heartbeat monitoring** - Publishes state every 60 seconds for device health
- **Multi-platform** - Runs on macOS, Windows, and Linux
- **Local persistence** - Saves lock state and configuration locally

## Requirements

- **Flutter SDK** 3.9+ (check with `flutter --version`)
- **Operating System** macOS 10.14+, Windows 10+, or Linux
- **AWS Account** with IoT Core access
- **Device certificates** generated by bikes-api provisioning system

## Architecture

```
lib/
â”œâ”€â”€ main.dart                           # Application entry point
â”œâ”€â”€ app.dart                            # Root widget with routing
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â”œâ”€â”€ app_constants.dart         # UI/behavior constants
â”‚   â”‚   â””â”€â”€ aws_constants.dart         # AWS region, service URLs
â”‚   â””â”€â”€ utils/
â”‚       â””â”€â”€ logger.dart                # Structured logging
â”‚
â”œâ”€â”€ features/                           # Feature-based architecture
â”‚   â”œâ”€â”€ aws_config/                    # AWS endpoint & profile management
â”‚   â”‚   â”œâ”€â”€ presentation/screens/aws_config_screen.dart
â”‚   â”‚   â””â”€â”€ providers/aws_config_providers.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ certificates/                  # Device certificate management
â”‚   â”‚   â”œâ”€â”€ presentation/screens/certificates_screen.dart
â”‚   â”‚   â””â”€â”€ providers/certificates_providers.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ locks/                         # CORE: Virtual lock simulator
â”‚   â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”‚   â””â”€â”€ entities/lock_state.dart          # Lock state model
â”‚   â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”‚   â”œâ”€â”€ screens/locks_screen.dart         # Main lock UI
â”‚   â”‚   â”‚   â””â”€â”€ widgets/lock_card.dart            # Lock state display
â”‚   â”‚   â””â”€â”€ providers/locks_providers.dart        # â˜… LOCK SIMULATOR LOGIC â˜…
â”‚   â”‚       â”œâ”€â”€ LocksNotifier (timer, state machine, auto-lock)
â”‚   â”‚       â”œâ”€â”€ Timer countdown loop (1 sec updates)
â”‚   â”‚       â”œâ”€â”€ Shadow delta handling (commands from bikes-api)
â”‚   â”‚       â”œâ”€â”€ State publishing (reported state + heartbeat)
â”‚   â”‚       â””â”€â”€ Local persistence (Hive storage)
â”‚   â”‚
â”‚   â”œâ”€â”€ things/                        # IoT Things metadata management
â”‚   â”‚   â”œâ”€â”€ domain/entities/thing.dart
â”‚   â”‚   â”œâ”€â”€ presentation/screens/things_screen.dart
â”‚   â”‚   â””â”€â”€ providers/things_providers.dart
â”‚   â”‚
â”‚   â””â”€â”€ settings/                      # Application settings
â”‚       â”œâ”€â”€ presentation/screens/settings_screen.dart
â”‚       â””â”€â”€ providers/settings_providers.dart
â”‚
â””â”€â”€ services/                           # Cross-cutting concerns
    â”œâ”€â”€ aws_iot_service.dart           # AWS IoT REST API client (provisioning)
    â”œâ”€â”€ connection_manager.dart        # MQTT connection management + shadow updates
    â”œâ”€â”€ mqtt_service.dart              # MQTT client wrapper (mqtt_client)
    â””â”€â”€ storage_service.dart           # Local storage (Hive + SharedPreferences)
```

### Core Components Explained

#### ğŸ”’ Lock Simulator (`locks_providers.dart` - LocksNotifier)
**This is where the simulation logic lives:**
- **Timer Management**: Countdown loop every 1 second
- **State Machine**: Transitions between locked/unlocked states
- **Auto-lock Logic**: Automatically re-locks when timer expires
- **Shadow Delta Handler**: Processes unlock commands from bikes-api
- **Heartbeat Loop**: Publishes lock state every 60 seconds
- **Local Persistence**: Saves state to Hive for recovery after restart

#### ğŸŒ Connection Manager (`services/connection_manager.dart`)
- Manages MQTT connections to AWS IoT Core
- Handles Device Shadow subscriptions and updates
- Supports multiple lock devices (connection pooling)
- Tracks connection state and publishes state changes
- Two simulation modes: Master (broadcaster) and Slave (listener)

#### ğŸ“¦ Storage Service (`services/storage_service.dart`)
- Local storage using Hive (key-value database)
- Stores device certificates securely
- Persists lock state between sessions
- Manages AWS credentials and configuration

## Setup Instructions

### Step 1: Install Dependencies

```bash
flutter pub get
```

### Step 2: AWS IoT Setup

#### 2a. Download AWS Root CA Certificate

```bash
# Create directory for certificates
mkdir -p assets/ca

# Download Amazon Root CA 1
curl -o assets/ca/AmazonRootCA1.pem https://www.amazontrust.com/repository/AmazonRootCA1.pem

# Verify file exists
ls -la assets/ca/AmazonRootCA1.pem
```

#### 2b. Get Your AWS IoT Endpoint

1. Go to [AWS IoT Console](https://console.aws.amazon.com/iotv2/)
2. Click **Settings** in the left menu
3. Copy your **Device data endpoint** (e.g., `abc123def.iot.eu-west-1.amazonaws.com`)
4. You'll enter this in the app

### Step 3: Device Certificates

Device certificates are generated by the bikes-api provisioning system. You have two options:

**Option A: Import from bikes-api (Recommended)**
1. Generate certificates using bikes-api: `bun run provision`
2. In the app, use Certificates screen to import them
3. Select the certificate file, enter AWS profile

**Option B: Manual Generation**
1. In AWS IoT Console, create a certificate
2. Download the certificate files (`.pem` and `-private.key`)
3. In the app, import the files

### Step 4: Configure AWS Profile

1. Launch the app
2. Go to **AWS Config** tab
3. Select your AWS profile (from `~/.aws/credentials`)
4. Enter your IoT endpoint
5. Click "Discover Endpoint" to verify connection

### Step 5: Load Locks

1. Go to **Locks** tab
2. Click "Load Locks" 
3. The app will:
   - Scan for local device certificates
   - Create virtual lock instances
   - Attempt to connect to AWS IoT Core

## Running

### macOS

```bash
flutter run -d macos
```

### Windows

```bash
flutter run -d windows
```

### Linux

```bash
flutter run -d linux
```

### Development (Debug Mode with Hot Reload)

```bash
flutter run -d <macos|windows|linux> --debug
```

## How It Works: Lock Lifecycle

### 1. **Initialization**
   - App loads device certificates from local storage
   - LocksNotifier creates LockState for each device
   - Timer countdown loop starts (1 sec updates)

### 2. **Connection**
   - ConnectionManager connects to AWS IoT Core via MQTT
   - Subscribes to shadow delta topic for each lock
   - Shadow delta stream emits unlock commands

### 3. **Unlock Command Received** (from bikes-api)
   ```
   bikes-api sends: { "state": { "desired": { "locked": 0 } } }
   â†“
   Shadow delta arrives at app
   â†“
   LocksNotifier.applyDelta() updates lock state
   â†“
   Timer starts (auto-lock after N seconds)
   â†“
   Counter counts down: 30s â†’ 29s â†’ ... â†’ 0s
   â†“
   Auto-lock: lock.locked = 1, timer cleared
   â†“
   Publish reported state: { "locked": 1 }
   ```

### 4. **Heartbeat**
   - Every 60 seconds, LocksNotifier publishes lock state
   - Reports: `{ locked, empty, lock_clamps, timer }`
   - Lets bikes-api monitor device health

### 5. **State Persistence**
   - Lock state saved to Hive after every change
   - On restart, app recovers previous state
   - Lost WiFi? App reconnects and syncs

## State Model

```dart
class LockState {
  final String thingId;           // AWS IoT Thing name
  final bool connected;           // Connected to AWS IoT?
  final int locked;               // 1 = locked, 0 = unlocked
  final int empty;                // 1 = no bike, 0 = bike present
  final int lockClamps;           // 1 = OK, 0 = error
  final int? timer;               // Milliseconds until auto-lock
  final DateTime? lastUpdate;     // Last state change time
}
```

## Testing the Simulator

### Manual Testing

1. **Start the app and connect**
2. **Send unlock command from bikes-api:**
   ```bash
   curl -X POST https://dev.bikes-api.com/locks/lock-001/unlock \
     -H "Authorization: Bearer token"
   ```
3. **Observe in app:**
   - Lock state changes to "Unlocked"
   - Timer countdown visible
   - Auto-locks after timer expires

### Simulating Bike Removal
1. In Locks screen, toggle "Empty" button
2. Publishes to AWS IoT: `{ "empty": 1 }`
3. bikes-api receives rental completion signal

## Troubleshooting

### "Cannot find package '@pulumi/aws'"
- This error is for bikes-api, not this app
- Make sure you're in the `bikes-virtlocks` directory

### "Failed to connect to AWS IoT"
- Verify AWS profile exists: `aws configure list`
- Check IoT endpoint is correct (Settings tab)
- Ensure CA certificate is in `assets/ca/AmazonRootCA1.pem`
- Device certificates must match the endpoint region

### "Lock state not updating"
- Check device is in connected state (Locks tab)
- Verify heartbeat is sending (logs show "Heartbeat: publishing state...")
- Try manually toggling lock state in UI to test

### "Certificates not loading"
- Ensure certificate files are in correct location
- Check file permissions: `ls -l ~/.bikes_virtlocks/`
- Certificates must be in PEM format

## Development

### Project Structure
- **Domain Layer** (`domain/`) - Entities and business logic
- **Presentation Layer** (`presentation/`) - UI widgets and screens
- **Provider Layer** (`providers/`) - State management with Riverpod
- **Services Layer** (`services/`) - External integrations

### State Management
Uses **Riverpod 2.x** with:
- `StateNotifier` for complex state (LocksNotifier)
- `Provider` for derived state (filteredLocksProvider)
- `FutureProvider` for async operations
- Reactive streams for MQTT messages

### Code Generation
Run after modifying models or providers:
```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

## Related Projects

- **[bikes-api](https://github.com/adam-ai-rob/bikes-api)** - Backend API and AWS infrastructure
- **[bikes-virtlocks](https://github.com/adam-ai-rob/bikes-virtlocks)** - This virtual lock simulator

## Support

For issues or questions:
1. Check the [Troubleshooting](#troubleshooting) section
2. Review bikes-api documentation
3. Check AWS IoT Core documentation

---

**Last Updated:** February 2, 2026
